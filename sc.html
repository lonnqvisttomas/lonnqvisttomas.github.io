<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step Tracker</title>
    <!-- Google Maps API will be loaded with a callback -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; }
        header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .tracker-panel { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-box .label { font-size: 0.9em; opacity: 0.9; margin-bottom: 8px; }
        .stat-box .value { font-size: 2em; font-weight: bold; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        button { padding: 12px 30px; font-size: 1.1em; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:active { transform: scale(0.98); }
        .btn-start { background: #4CAF50; color: white; }
        .btn-start:hover:not(:disabled) { background: #45a049; }
        .btn-start:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-stop { background: #f44336; color: white; }
        .btn-stop:hover:not(:disabled) { background: #da190b; }
        .btn-stop:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-reset { background: #FF9800; color: white; grid-column: 1 / -1; }
        .btn-reset:hover:not(:disabled) { background: #e68900; }
        .btn-add-steps { background: #2196F3; color: white; grid-column: 1 / -1; }
        .btn-add-steps:hover:not(:disabled) { background: #0b7dda; }
        .history-panel { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); max-height: 600px; overflow-y: auto; }
        .history-panel h2 { margin-bottom: 20px; color: #333; }
        .history-item { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border-left: 4px solid #667eea; transition: 0.3s; }
        .history-item:hover { background: #e8e8ff; }
        .history-item .date { font-weight: bold; color: #333; margin-bottom: 5px; }
        .history-item .details { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9em; color: #666; }
        .map-container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); grid-column: 1 / -1; }
        #map { width: 100%; height: 400px; border-radius: 10px; }
        .empty-message { text-align: center; color: #999; padding: 40px 20px; }
        .status-message { text-align: center; color: #666; font-size: 0.9em; padding: 10px; margin-top: 10px; border-radius: 5px; background: #f9f9f9; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 90%; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-close { float: right; font-size: 28px; cursor: pointer; color: #666; background: none; border: none; padding: 0; }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš¶ Step Tracker</h1>
            <p>Track your walks with GPS mapping</p>
        </header>

        <div class="main-content">
            <div class="tracker-panel">
                <h2>Current Session</h2>
                <div class="stats-grid">
                    <div class="stat-box"><div class="label">Steps</div><div class="value" id="steps">0</div></div>
                    <div class="stat-box"><div class="label">Time</div><div class="value" id="time">00:00</div></div>
                    <div class="stat-box"><div class="label">Distance</div><div class="value" id="distance">0.0 km</div></div>
                    <div class="stat-box"><div class="label">Speed</div><div class="value" id="speed">0.0 km/h</div></div>
                </div>

                <div class="controls">
                    <button class="btn-start" id="startBtn">Start</button>
                    <button class="btn-stop" id="stopBtn" disabled>Stop</button>
                    <button class="btn-reset" id="resetBtn" disabled>Reset</button>
                    <button class="btn-add-steps" id="addStepsBtn">+ Add Steps</button>
                </div>

                <div id="status" class="status-message">Press Start to begin tracking</div>
            </div>

            <div class="history-panel">
                <h2>Session History</h2>
                <div id="history"><div class="empty-message">No sessions recorded yet</div></div>
            </div>
        </div>

        <div class="map-container">
            <h2>Current Route</h2>
            <div id="map"></div>
        </div>
    </div>

    <div class="modal" id="mapModal">
        <div class="modal-content">
            <button class="modal-close" id="closeModalBtn">&times;</button>
            <h2>Session Route</h2>
            <div id="modalMap" style="width: 100%; height: 500px; border-radius: 10px; margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Load Google Maps JS API (replace YOUR_API_KEY with an actual key) -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initGoogleMap"></script>
    <script>
        const app = {
            isTracking: false, sessionStartTime: null, sessionElapsedTime: 0, timerInterval: null,
            currentCoordinates: [], totalDistance: 0, lastCoordinate: null, sessionHistory: [],
            map: null, polyline: null, watchId: null, stepCount: 0, manualSteps: 0,
            lastStepTime: 0, deviceMotionAvailable: false
        };

        const elements = {
            startBtn: null, stopBtn: null, resetBtn: null, addStepsBtn: null,
            steps: null, time: null, distance: null, speed: null, status: null,
            history: null, map: null, mapModal: null, closeModalBtn: null, modalMap: null
        };

        // Google Maps API will call this when ready
        function initGoogleMap() {
            initializeApp();
            initMap();
        }

        function initializeApp() {
            elements.startBtn = document.getElementById('startBtn');
            elements.stopBtn = document.getElementById('stopBtn');
            elements.resetBtn = document.getElementById('resetBtn');
            elements.addStepsBtn = document.getElementById('addStepsBtn');
            elements.steps = document.getElementById('steps');
            elements.time = document.getElementById('time');
            elements.distance = document.getElementById('distance');
            elements.speed = document.getElementById('speed');
            elements.status = document.getElementById('status');
            elements.history = document.getElementById('history');
            elements.map = document.getElementById('map');
            elements.mapModal = document.getElementById('mapModal');
            elements.closeModalBtn = document.getElementById('closeModalBtn');
            elements.modalMap = document.getElementById('modalMap');

            elements.startBtn.addEventListener('click', startTracking);
            elements.stopBtn.addEventListener('click', stopTracking);
            elements.resetBtn.addEventListener('click', resetSession);
            elements.addStepsBtn.addEventListener('click', addStepsManually);
            elements.closeModalBtn.addEventListener('click', closeModal);
            elements.mapModal.addEventListener('click', function(e) { if (e.target === this) closeModal(); });

            loadHistory();
            // map will be initialized later once Google Maps API has loaded via initGoogleMap
        }

        function initMap() {
            try {
                if (!app.map) {
                    app.map = new google.maps.Map(elements.map, {
                        center: { lat: 51.505, lng: -0.09 },
                        zoom: 13
                    });
                }
            } catch (e) { console.error('Map error:', e); }
        }

        function startTracking() {
            if (!navigator.geolocation) { alert('Geolocation not supported'); return; }

            app.isTracking = true;
            app.sessionStartTime = Date.now();
            app.sessionElapsedTime = 0;
            app.currentCoordinates = [];
            app.totalDistance = 0;
            app.lastCoordinate = null;
            app.stepCount = 0;
            app.manualSteps = 0;

            elements.startBtn.disabled = true;
            elements.stopBtn.disabled = false;
            elements.resetBtn.disabled = true;
            elements.status.textContent = 'Tracking active...';

            if (app.polyline && app.map) app.map.removeLayer(app.polyline);
            app.timerInterval = setInterval(updateTimer, 100);

            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            app.deviceMotionAvailable = true;
                            window.addEventListener('devicemotion', detectSteps);
                        } else {
                            app.deviceMotionAvailable = false;
                            updateStatus('Auto step detection unavailable - use +Add Steps');
                        }
                    })
                    .catch(() => { app.deviceMotionAvailable = false; });
            } else if (window.DeviceMotionEvent) {
                app.deviceMotionAvailable = true;
                window.addEventListener('devicemotion', detectSteps);
            }

            app.watchId = navigator.geolocation.watchPosition(onPositionSuccess, onPositionError,
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 });
        }

        function stopTracking() {
            app.isTracking = false;
            if (app.watchId) navigator.geolocation.clearWatch(app.watchId);
            if (app.timerInterval) clearInterval(app.timerInterval);
            if (app.deviceMotionAvailable) window.removeEventListener('devicemotion', detectSteps);

            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            elements.resetBtn.disabled = false;
            updateStatus('Session stopped. Press Reset for new session.');
            saveSession();
        }

        function resetSession() {
            if (!confirm('Reset session?')) return;

            app.isTracking = false;
            app.sessionStartTime = null;
            app.sessionElapsedTime = 0;
            app.currentCoordinates = [];
            app.totalDistance = 0;
            app.lastCoordinate = null;
            app.stepCount = 0;
            app.manualSteps = 0;

            elements.steps.textContent = '0';
            elements.time.textContent = '00:00';
            elements.distance.textContent = '0.0 km';
            elements.speed.textContent = '0.0 km/h';
            updateStatus('Ready to track');

            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            elements.resetBtn.disabled = true;

            if (app.polyline && app.map) app.map.removeLayer(app.polyline);
        }

        function onPositionSuccess(position) {
            const { latitude, longitude } = position.coords;
            if (!latitude || !longitude) return;

            const newCoord = { lat: latitude, lng: longitude };

            if (app.lastCoordinate) {
                const dist = calculateDistance(app.lastCoordinate.lat, app.lastCoordinate.lng, latitude, longitude);
                if (dist > 0.00005) {
                    app.totalDistance += dist;
                    app.currentCoordinates.push(newCoord);
                    updatePolyline();
                }
            } else {
                app.currentCoordinates.push(newCoord);
            }

            app.lastCoordinate = newCoord;
            elements.distance.textContent = app.totalDistance.toFixed(2) + ' km';
            if (!app.deviceMotionAvailable) elements.steps.textContent = (Math.floor(app.totalDistance * 1312) + app.manualSteps);
        }

        function onPositionError(error) { console.warn('Location error:', error.code); }

        function detectSteps(event) {
            if (!app.isTracking) return;
            const x = event.acceleration.x || 0, y = event.acceleration.y || 0, z = event.acceleration.z || 0;
            const mag = Math.sqrt(x * x + y * y + z * z);
            if (mag > 25) {
                const now = Date.now();
                if (now - app.lastStepTime > 400) {
                    app.stepCount++;
                    updateStepDisplay();
                    app.lastStepTime = now;
                }
            }
        }

        function updatePolyline() {
            if (!app.map) return;
            if (app.polyline) {
                app.polyline.setMap(null);
            }
            if (app.currentCoordinates.length > 1) {
                const googlePath = app.currentCoordinates.map(c => ({ lat: c.lat, lng: c.lng }));
                app.polyline = new google.maps.Polyline({
                    path: googlePath,
                    geodesic: true,
                    strokeColor: '#4285F4',
                    strokeOpacity: 1.0,
                    strokeWeight: 3
                });
                app.polyline.setMap(app.map);
                const bounds = new google.maps.LatLngBounds();
                googlePath.forEach(p => bounds.extend(p));
                app.map.fitBounds(bounds);

                new google.maps.Marker({ position: googlePath[0], map: app.map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#4CAF50', fillOpacity: 0.8, strokeColor: '#fff', strokeWeight: 2 } });
                new google.maps.Marker({ position: googlePath[googlePath.length - 1], map: app.map, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 5, fillColor: '#2196F3', fillOpacity: 0.8, strokeColor: '#fff', strokeWeight: 2 } });
            }
        }

        function updateTimer() {
            if (!app.isTracking) return;
            app.sessionElapsedTime = Date.now() - app.sessionStartTime;
            elements.time.textContent = formatTime(app.sessionElapsedTime);
            if (app.currentCoordinates.length > 0) {
                const hours = app.sessionElapsedTime / (1000 * 60 * 60);
                const speed = hours > 0 ? app.totalDistance / hours : 0;
                elements.speed.textContent = speed.toFixed(1) + ' km/h';
            }
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function addStepsManually() {
            if (!app.isTracking) { alert('Start tracking first'); return; }
            const input = prompt('Add steps:', '10');
            if (input && !isNaN(input)) {
                app.manualSteps += parseInt(input);
                updateStepDisplay();
            }
        }

        function updateStepDisplay() {
            const total = app.stepCount + app.manualSteps;
            elements.steps.textContent = total;
        }

        function saveSession() {
            if (app.currentCoordinates.length === 0) { alert('No location data. Enable GPS.'); return; }

            const session = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                time: formatTime(app.sessionElapsedTime),
                distance: app.totalDistance.toFixed(2),
                steps: app.stepCount + app.manualSteps,
                coordinates: app.currentCoordinates,
                duration: app.sessionElapsedTime
            };

            app.sessionHistory.unshift(session);
            saveHistory();
            updateHistoryDisplay();
        }

        function loadHistory() {
            try {
                const saved = localStorage.getItem('stepTrackerHistory');
                if (saved) {
                    app.sessionHistory = JSON.parse(saved);
                    updateHistoryDisplay();
                }
            } catch (e) { console.warn('Could not load history'); }
        }

        function saveHistory() {
            try {
                localStorage.setItem('stepTrackerHistory', JSON.stringify(app.sessionHistory));
            } catch (e) { console.warn('Could not save history'); }
        }

        function updateHistoryDisplay() {
            if (app.sessionHistory.length === 0) {
                elements.history.innerHTML = '<div class="empty-message">No sessions recorded yet</div>';
                return;
            }

            elements.history.innerHTML = app.sessionHistory.map(s => `
                <div class="history-item" data-id="${s.id}">
                    <div class="date">${s.date}</div>
                    <div class="details">
                        <div><span style="font-size: 0.8em; color: #999;">Distance</span><div><strong>${s.distance} km</strong></div></div>
                        <div><span style="font-size: 0.8em; color: #999;">Time</span><div><strong>${s.time}</strong></div></div>
                        <div><span style="font-size: 0.8em; color: #999;">Steps</span><div><strong>${s.steps}</strong></div></div>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', function() {
                    const sessionId = parseInt(this.getAttribute('data-id'));
                    viewSession(sessionId);
                });
            });
        }

        function viewSession(sessionId) {
            const session = app.sessionHistory.find(s => s.id === sessionId);
            if (!session) return;

            elements.mapModal.classList.add('active');
            elements.modalMap.innerHTML = '';

            setTimeout(() => {
                try {
                    const modalMap = new google.maps.Map(elements.modalMap, {
                        center: { lat: 51.505, lng: -0.09 },
                        zoom: 13
                    });
                    const path = session.coordinates.map(c => ({ lat: c.lat, lng: c.lng }));
                    const polyline = new google.maps.Polyline({ path, geodesic: true, strokeColor: '#4285F4', strokeOpacity: 1.0, strokeWeight: 3 });
                    polyline.setMap(modalMap);
                    const bounds = new google.maps.LatLngBounds();
                    path.forEach(p => bounds.extend(p));
                    modalMap.fitBounds(bounds);

                    new google.maps.Marker({ position: path[0], map: modalMap, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#4CAF50', fillOpacity: 0.8, strokeColor: '#fff', strokeWeight: 2 } });
                    new google.maps.Marker({ position: path[path.length - 1], map: modalMap, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#f44336', fillOpacity: 0.8, strokeColor: '#fff', strokeWeight: 2 } });
                } catch (e) { console.error('Modal map error:', e); }
            }, 100);
        }

        function closeModal() { elements.mapModal.classList.remove('active'); }

        function updateStatus(msg) { elements.status.textContent = msg; }

        // initialization kicked off by Google Maps callback
    </script>
</body>
</html>
